---
- name: Setup instances
  hosts: all
  become: yes
  tasks:
    - name: Install OpenJDK 8
      apt:
        name: openjdk-8-jdk
        update_cache: yes

    - name: Install Docker
      apt:
        name: docker.io
        update_cache: yes
      when: "'instance_2' in inventory_hostname"

- name: Build App
  hosts: instance_1
  tasks:
    - name: Copy repository
      synchronize:
        src: ../
        dest: /home/ubuntu/certask

    - name: Build with Gradle
      command: ./gradlew clean build
      args:
        chdir: /home/ubuntu/certask

    - name: Copy WAR file
      command: cp build/libs/hello-1.0.war /home/ubuntu

- name: Deploy App
  hosts: instance_2
  tasks:
    - name: Copy WAR file
      synchronize:
        src: /home/ubuntu/hello-1.0.war
        dest: /home/ubuntu

    - name: Copy Dockerfile
      synchronize:
        src: ../Dockerfile
        dest: /home/ubuntu

    - name: Build Docker image
      command: docker build -t hello-app .

    - name: Run Docker container
      command: docker run -d -p 8080:8080 hello-app
